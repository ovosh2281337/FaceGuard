import telegram
from telegram import error
import asyncio
from config_manager import get_config # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
import logging

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è ---
# –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω.
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s - %(levelname)s - %(message)s',
                    handlers=[
                        logging.FileHandler("guard.log", mode='a'),
                        logging.StreamHandler()
                    ])

# --------------------------------------------------------------------
# --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ü–†–ê–í–ö–ê –¢–†–ï–í–û–ñ–ù–û–ì–û –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
# --------------------------------------------------------------------

async def send_alert_async(bot_token, chat_id, image_path):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ñ–æ—Ç–æ."""
    try:
        bot = telegram.Bot(token=bot_token)
        caption_text = "üö® **–í–Ω–∏–º–∞–Ω–∏–µ!** üö®\n\n–û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ –≤–∞—à–∏–º –ü–ö."
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é, –∏—Å–ø–æ–ª—å–∑—É—è Markdown –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        await bot.send_photo(chat_id=chat_id, photo=open(image_path, 'rb'), caption=caption_text, parse_mode='Markdown')
        
        logging.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram —á–∞—Ç {chat_id}.")
    except error.BadRequest as e:
        # –ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π chat_id
        logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ Telegram (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ ID —á–∞—Ç–∞): {e}")
    except error.Unauthorized as e:
        # –ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
        logging.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞): {e}")
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ –≤ Telegram: {e}")

def send_alert(image_path):
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è "–æ–±–µ—Ä—Ç–∫–∞" –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞.
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ç—Ä–µ–≤–æ–≥–∏.
    """
    config = get_config() # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    bot_token = config.get('Telegram', 'bot_token', fallback='')
    chat_id = config.get('Telegram', 'chat_id', fallback='')
    
    if not bot_token or bot_token == "–í–ê–®_–¢–û–ö–ï–ù_–û–¢_BOTFATHER" or not chat_id:
        logging.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–ª–∏ ID —á–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ config.ini! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return
        
    asyncio.run(send_alert_async(bot_token, chat_id, image_path))


# --------------------------------------------------------------------
# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ü–†–ê–í–ö–ê –¢–ï–°–¢–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø ---
# --------------------------------------------------------------------

async def send_test_message_async(bot_token, chat_id):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    try:
        bot = telegram.Bot(token=bot_token)
        text = "‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç FaceGuard. –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
        await bot.send_message(chat_id=chat_id, text=text)
        logging.info(f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram —á–∞—Ç {chat_id}.")
        return True
    except error.BadRequest:
        logging.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π ID —á–∞—Ç–∞.")
        return False
    except error.Unauthorized:
        logging.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.")
        return False
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram: {e}")
        return False

def send_test_message():
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è "–æ–±–µ—Ä—Ç–∫–∞" –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–∑ UI.
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–µ—Å—Ç–∞.
    """
    config = get_config() # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    bot_token = config.get('Telegram', 'bot_token', fallback='')
    chat_id = config.get('Telegram', 'chat_id', fallback='')
    
    if not bot_token or bot_token == "–í–ê–®_–¢–û–ö–ï–ù_–û–¢_BOTFATHER" or not chat_id:
        logging.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–ª–∏ ID —á–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ config.ini! –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        # –í UI –º—ã —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º messagebox, –∑–¥–µ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–∞.
        return
        
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    asyncio.run(send_test_message_async(bot_token, chat_id))
